<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>留言墙－MoMa</title>
<link href="style.css" rel="stylesheet" type="text/css" media="screen" />
<script src="js/jquery-1.10.2.js"></script>
<script src="jquery.nested.js"></script>
<script src="makeboxes.js"></script>
<script src="/socket.io/socket.io.js"></script>            
</head>
<body>

<a class="btn" id="prepend">next</a>
<div id="container">
</div>


<div id="container11" style="display:none;">
  <div class="box size12">1</div>
  <div class="box size12">2</div>
  <div class="box size24">3</div>
  <div class="box size22">4</div>
  <div class="box size12">5</div>
  <div class="box size12">6</div>
  <div class="box size12">7</div>
  <div class="box size12">8</div>
  <div class="box size12">9</div>
  <div class="box size12">10</div>
</div>

<a class="btn" id="append">Append</a>

<script type="text/javascript" >
  
  $(function() { 
   var w=window.innerWidth|| document.documentElement.clientWidth|| document.body.clientWidth;
   
    $('#container').nested({
      minWidth: w / 7,
      resizeToFit: false,
      gutter: 10,
  animate: true,
  animationOptions: {   
    queue: true,
    speed: 100,
    duration: 100,
    complete: function(p1,p2){
      //remove boxes and cache img outside screen.
      //$('#container').removeOutItems();
      setTimeout(function(){
        var mt =window.innerHeight|| document.documentElement.clientHeight|| document.body.clientHeight;
        $.each(p1, function (index, value) {
             var el = $(value['$el']);
             var top = el.position().top;
             //移除视窗之外的条，避免出现半拉子条
             if(top>mt 
              //|| (top>0 && el.hasClass('size24'))
              ){
               var src = el.children('img').attr('src');
               if(src.indexOf('/upload')==0)
                  pics_cache.push(src);
               el.remove();
             }
         });
          $('#prepend').text('next');
      },225);
      
    }
  }
    }); 
    
    $('#prepend').click(function(){
      if($('#prepend').text().indexOf('...')!=-1)
        return false;
      $('#prepend').text('waiting...');
      var boxes = makeBoxes(3);
      $('#container').prepend(boxes).nested('prepend',boxes);
    })
    $('#append').click(function(){
      var boxes = makeBoxes();
      $('#container').append(boxes).nested('append',boxes);     
    })

  });


    var socket = io.connect(location.host);
    //订阅图片目录
    socket.on('connect', function(data) {
      socket.emit('join', '/upload');
    });
    socket.on('added', function(data) {
      var pics=[];
      for(var i=0; i<data.length; i++){
        if(data[i].indexOf('/upload')==0){
          pics.push(data[i]);
        }else{
          console.log(data[i]);
        }
      }
      if(pics.length==0)
        return false;
      $('#prepend').text('waiting...');
      var boxes = makeBoxesByData(pics);
      $('#container').prepend(boxes).nested('prepend',boxes);
    });
			  
</script>
  
</body>
</html>    